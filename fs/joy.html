<!DOCTYPE HTML>
<html>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<head>
    <title>Joy</title>
    <style>
        body {
            margin: 0px;
            padding: 0px;
        }
        
        #joystick {
            border: 1px solid #9C9898;
        }
    </style>
    <script src="joy.min.js"></script>
</head>

<body>
    <!--joystick-->
    <div id="joyDiv" style="width:200px;height:200px;margin-bottom:20px;margin:50px"></div>
    <!--buttons-->
    <div style="text-align:center;width:320px;">
      <button onclick="execFunction({'cmd': 'j'})">LOOK LEFT</button>
      <button onclick="execFunction({'cmd': 'l'})">LOOK RIGHT</button>
      </br> 
      <button onclick="execFunction({'cmd': 'k'})">NORMAL</button>
      <button onclick="execFunction({'cmd': 'i'})">SAD</button>
      </br> 
      <button onclick="execFunction({'cmd': '.'})">ON/OFF Motors</button>
    </div>
    </br>

    Socket Status:
    <input id="socketStatus" type="text" />
    </br>
    

    <script type="text/javascript">

        // Let us open a web socket
        var ws = new WebSocket(((window.location.protocol === "https:") ? "wss://" : "ws://") + window.location.host + "/rpc") //new WebSocket(wsUri);

        ws.onopen = function() {
            console.log("Connection is open...");

        };

        ws.onmessage = function(evt) {
            var received_msg = evt.data;
            console.log(received_msg);
        };

        ws.onclose = function() {

            // websocket is closed.
            console.log("Connection is closed...");
        };
        //} else {

        // The browser doesn't support WebSocket
        //  alert("WebSocket NOT supported by your Browser!");
        //}

        var lastX = 0;
        var lastY = 0;

        function execFunction(args) {

            ws.send(JSON.stringify({
                method: "Walle.Exec",
                args
            }));

            lastX = joy.GetX();
            lastY = joy.GetY();

        }

        function execCommandMove() {
            // Web Socket is connected, send data using send()
            if (typeof ws !== 'undefined' && (lastX !== joy.GetX() || lastY !== joy.GetY())) {

                var x = -parseInt(joy.GetX());
                var y = parseInt(joy.GetY());

                ws.send(JSON.stringify({
                    method: "Walle.Move",
                    args: {
                        x: x,
                        y: y
                    }
                }));

                lastX = joy.GetX();
                lastY = joy.GetY();

            }

        }



        function checkCommandMove() {

            //avoid flooding command 
            if (lastX != joy.GetX() || lastY != joy.GetY()) {

                //edges (move)
                if (joy.GetX() >= 100 || joy.GetY() >= 100 || joy.GetX() <= -100 || joy.GetY() <= -100) {
                  execCommandMove();
                }

                //stop
                else if (joy.GetX() == 0 && joy.GetY() == 0) {
                  execCommandMove();
                }

            }

        }

        // Create JoyStick object into the DIV 'joyDiv'
        var joy = new JoyStick('joyDiv');
  
        var x = document.getElementById("X");
        var y = document.getElementById("Y");

        var socketStatus = document.getElementById("socketStatus");

        setInterval(function() {
          checkCommandMove();
        }, 50);

        setInterval(function() {
          switch(ws.readyState) {
            case 0:
              socketStatus.value = "Connecting";
              break;
            case 1:
              socketStatus.value = "Connected";
              break;
            case 2:
              socketStatus.value = "Closing";
              break;
            default:
              socketStatus.value = "Closed";
          }
            
        }, 1000);
    </script>
</body>

</html>